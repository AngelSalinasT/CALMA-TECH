#!/bin/bash

echo "=========================================="
echo "üîÑ RESET Y TEST DE CLASSROOM"
echo "=========================================="
echo ""

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}Este script te ayudar√° a resolver el problema de carga de Classroom${NC}"
echo ""

echo "=========================================="
echo "üìã DIAGN√ìSTICO DEL PROBLEMA"
echo "=========================================="
echo ""
echo "El error 401 Unauthorized indica que:"
echo "  ‚Ä¢ El login funciona correctamente ‚úì"
echo "  ‚Ä¢ Pero el token NO tiene permisos de Classroom ‚úó"
echo ""
echo "Esto sucede porque el token que obtuviste en el login anterior"
echo "no incluye los nuevos scopes de Classroom que acabamos de configurar."
echo ""

echo "=========================================="
echo "üîß SOLUCI√ìN"
echo "=========================================="
echo ""
echo "Necesitas hacer un NUEVO login para obtener un token con los"
echo "permisos correctos de Classroom."
echo ""

echo -e "${YELLOW}IMPORTANTE:${NC} Cuando hagas el nuevo login, Google te pedir√°"
echo "permisos adicionales para acceder a Google Classroom."
echo "Debes aceptar TODOS los permisos."
echo ""

echo "=========================================="
echo "‚úÖ PASOS A SEGUIR"
echo "=========================================="
echo ""

echo "1Ô∏è‚É£  Abre Google Cloud Console OAuth Consent Screen:"
echo "   ${BLUE}https://console.cloud.google.com/apis/credentials/consent?project=hackathon-2025-475302${NC}"
echo ""
echo "   Verifica que tenga estos scopes (en la secci√≥n 'Scopes'):"
echo "   ‚úì openid"
echo "   ‚úì .../auth/userinfo.email"
echo "   ‚úì .../auth/userinfo.profile"
echo "   ‚úì .../auth/classroom.courses.readonly"
echo "   ‚úì .../auth/classroom.rosters.readonly"
echo "   ‚úì .../auth/classroom.coursework.students.readonly"
echo "   ‚úì .../auth/classroom.coursework.me.readonly"
echo "   ‚úì .../auth/classroom.announcements.readonly"
echo ""
echo "   ${YELLOW}Si NO est√°n todos, agr√©galos:${NC}"
echo "   - Click en 'EDIT APP'"
echo "   - Click en 'SCOPES' ‚Üí 'ADD OR REMOVE SCOPES'"
echo "   - Busca 'classroom' y marca TODOS los scopes readonly"
echo "   - Click en 'UPDATE' y luego 'SAVE AND CONTINUE'"
echo ""

echo "2Ô∏è‚É£  Verifica que tu email est√© en Test Users:"
echo "   En la misma p√°gina, ve a la secci√≥n 'Test users'"
echo "   Tu email debe estar en la lista"
echo "   ${YELLOW}Si no est√°, agr√©galo:${NC}"
echo "   - Click en 'ADD USERS'"
echo "   - Ingresa tu email"
echo "   - Click en 'SAVE'"
echo ""

echo "3Ô∏è‚É£  Reinicia el backend (para cargar los nuevos scopes):"
echo ""
echo "   ${GREEN}cd backend${NC}"
echo "   ${GREEN}source venv/bin/activate${NC}"
echo "   ${GREEN}uvicorn app.main:app --reload${NC}"
echo ""

echo "4Ô∏è‚É£  Reinicia el frontend:"
echo ""
echo "   ${GREEN}cd frontend${NC}"
echo "   ${GREEN}npm run dev${NC}"
echo ""

echo "5Ô∏è‚É£  En el navegador:"
echo ""
echo "   a) Abre DevTools (F12)"
echo "   b) Ve a Application ‚Üí Storage ‚Üí Clear site data"
echo "   c) O simplemente borra localStorage con:"
echo "      ${GREEN}localStorage.clear()${NC} en la consola"
echo ""
echo "   d) Ve a ${BLUE}http://localhost:5173${NC}"
echo "   e) Haz login de nuevo con Google"
echo ""
echo "   ${YELLOW}‚ö†Ô∏è  IMPORTANTE:${NC}"
echo "   Google te mostrar√° una pantalla pidiendo permisos adicionales"
echo "   para acceder a Google Classroom. Debes aceptar TODOS."
echo ""
echo "   f) Una vez en el dashboard, abre la consola del navegador (F12)"
echo "      y la pesta√±a Network para ver las peticiones"
echo ""

echo "=========================================="
echo "üß™ VERIFICAR QUE FUNCIONA"
echo "=========================================="
echo ""
echo "Despu√©s del nuevo login:"
echo ""
echo "‚úì Deber√≠as ver tus cursos de Classroom"
echo "‚úì Deber√≠as ver tareas pendientes"
echo "‚úì Deber√≠as ver anuncios recientes"
echo ""
echo "Si NO funcion√≥, revisa:"
echo "  ‚Ä¢ Logs del backend: ${GREEN}tail -f backend_uvicorn.log${NC}"
echo "  ‚Ä¢ Consola del navegador (F12 ‚Üí Console)"
echo "  ‚Ä¢ Network tab del navegador (F12 ‚Üí Network)"
echo ""

echo "=========================================="
echo "‚ùì SI A√öN NO FUNCIONA"
echo "=========================================="
echo ""
echo "Posibles causas:"
echo ""
echo "1. La cuenta de Google no tiene cursos en Classroom"
echo "   ‚Üí Crea un curso de prueba o √∫nete a uno"
echo ""
echo "2. Los scopes no est√°n en el OAuth Consent Screen"
echo "   ‚Üí Verifica que TODOS est√©n agregados (paso 1)"
echo ""
echo "3. El email no est√° en Test Users"
echo "   ‚Üí Agr√©galo (paso 2)"
echo ""
echo "4. Google est√° usando cach√© de permisos"
echo "   ‚Üí Revoca el acceso manualmente en:"
echo "   ${BLUE}https://myaccount.google.com/connections${NC}"
echo "   ‚Üí Busca 'CALMA TECH' y elim√≠nalo"
echo "   ‚Üí Vuelve a hacer login"
echo ""

echo "=========================================="
echo ""
read -p "Presiona ENTER cuando hayas completado todos los pasos..."
